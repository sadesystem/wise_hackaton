<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Savings Goals</title>

    <!-- Saving Goals CSS -->
    <link rel="stylesheet" href="../assets/css/saving.css" />
</head>

<body>
<div class="app-wrapper">

    <!-- Ãœhine telefoniraam -->
    <div class="phone-frame">

        <!-- STATUS BAR -->
        <div class="device-device-frame-components-status-bar">
            <div class="time">9:30</div>
            <img class="right-icons" src="../assets/images/right-icons0.svg" />
            <img class="camera-cutout" src="../assets/images/camera-cutout0.svg" />
        </div>

        <!-- HOME BAR (iOS) -->
        <div class="device-device-frame-components-navigation">
            <div class="home"></div>
        </div>

        <!-- SCROLLITAV PÃ•HISISU -->
        <div class="saving-content">

            <!-- Header -->
            <header class="header">
                <h1>Saving Goals ğŸ¯</h1>
            </header>

            <!-- Add Goal Popup -->
            <div class="add-goal-popup" id="addGoalPopup">
                <div class="popup-content">
                    <h3>Add New Goal</h3>
                    <input type="text" id="goalName" placeholder="Goal name" />
                    <input type="number" id="goalAmount" placeholder="Target amount" />

                    <div class="popup-buttons">
                        <button id="cancelBtn">Cancel</button>
                        <button id="saveBtn">Save</button>
                    </div>
                </div>
            </div>

            <!-- STATIC GOAL CARDS REMOVED BY JS ON LOAD -->
            <section class="goal-card">
                <div class="goal-header">
                    <div class="goal-icon">ğŸ¨</div>
                    <div class="goal-info">
                        <div class="goal-title">Art Supplies</div>
                        <div class="goal-target">Target: 50â‚¬</div>
                    </div>
                    <div class="goal-progress">0%</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width:0%"></div>
                </div>
                <div class="goal-stats">
                    <span class="saved">Saved: 0.00â‚¬</span>
                    <span class="need">Need: 50.00â‚¬</span>
                </div>
            </section>

            <!-- ADD GOAL BUTTON -->
            <div class="add-goal-btn">
                <button id="addGoalBtn">+ Add Goal</button>
            </div>

            <!-- Motivation Card -->
            <section class="motivation-card">
                <div class="motivation-icon">ğŸŒŸ</div>
                <h2>Keep saving!</h2>
                <p>Every time you donâ€™t spend, youâ€™re closer to your goals. Youâ€™ve got this! ğŸ’ª</p>
            </section>

        </div> <!-- /saving-content -->

        <!-- BOTTOM NAVIGATION -->
        <div class="bottom-nav">
            <a href="../html/transactions.html" class="nav-item">
                <img src="../assets/images/vector0.svg" class="nav-icon" />
                <div class="nav-label">History</div>
            </a>

            <a href="../html/main.html" class="nav-item">
                <img src="../assets/images/home3.svg" class="nav-icon" />
                <div class="nav-label">Home</div>
            </a>

            <a href="../html/saving.html" class="nav-item">
                <img src="../assets/images/savings0.svg" class="nav-icon" />
                <div class="nav-label">Savings</div>
            </a>
        </div>

    </div> <!-- /phone-frame -->
</div> <!-- /app-wrapper -->


<script>
  const STORAGE_KEY = "jarsData";

  // loe jars kas localStorage'st vÃµi esmasel korral JSON failist
  async function getJarsData() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      return JSON.parse(stored);
    }

    // kui localStorage tÃ¼hi â†’ loe algandmed failist ja salvesta
    const response = await fetch("../data/jars.json");
    const data = await response.json();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    return data;
  }

  function saveJarsData(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function renderGoals(jars) {
    const container = document.querySelector(".saving-content");

    // eemalda olemasolevad goal-kaardid
    container.querySelectorAll(".goal-card").forEach(card => card.remove());

    jars.forEach(jar => {
      const percent = ((jar.current / jar.goal) * 100).toFixed(0);
      const need = (jar.goal - jar.current).toFixed(2);

      const card = document.createElement("section");
      card.classList.add("goal-card");
      card.style.cursor = "pointer";

      card.innerHTML = `
        <div class="goal-header">
          <div class="goal-icon">${jar.name.toLowerCase().includes("art") ? "ğŸ¨" : "ğŸš²"}</div>
          <div class="goal-info">
            <div class="goal-title">${jar.name}</div>
            <div class="goal-target">Target: ${jar.goal}â‚¬</div>
          </div>
          <div class="goal-progress">${percent}%</div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:${percent}%"></div>
        </div>
        <div class="goal-stats">
          <span class="saved">Saved: ${jar.current.toFixed(2)}â‚¬</span>
          <span class="need">Need: ${need}â‚¬</span>
        </div>
      `;

      card.addEventListener("click", () => {
        window.location.href = `../jar_progress_bar/jar_progress.html?id=${jar.id}`;
      });

      // lisame uue kaardi enne motivation-kaarti
      container.insertBefore(card, container.querySelector(".add-goal-btn"));
    });
  }

  async function loadGoals() {
    const data = await getJarsData();
    renderGoals(data.jars);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const addBtn = document.getElementById("addGoalBtn");
    const popup = document.getElementById("addGoalPopup");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");

    // lae olemasolevad goals (localStorage vÃµi JSON)
    loadGoals();

    addBtn.addEventListener("click", () => {
      popup.style.display = "flex";
    });

    cancelBtn.addEventListener("click", () => {
      popup.style.display = "none";
    });

    saveBtn.addEventListener("click", async () => {
      const nameInput = document.getElementById("goalName");
      const amountInput = document.getElementById("goalAmount");

      const name = nameInput.value.trim();
      const goalAmount = parseFloat(amountInput.value);

      if (!name || isNaN(goalAmount)) {
        alert("Please enter valid goal name and amount.");
        return;
      }

      // loe olemasolevad jars'id localStorage'st
      const data = await getJarsData();

      // leia uus id
      const newId = data.jars.length ? Math.max(...data.jars.map(j => j.id)) + 1 : 1;

      const newJar = {
        id: newId,
        name: name.toLowerCase(),
        goal: goalAmount,
        current: 0
      };

      data.jars.push(newJar);
      saveJarsData(data); // â¬…ï¸ SALVESTA localStorage'i

      // uuenda kuvatud goals (vÃµiks renderdada uuesti kogu listi)
      renderGoals(data.jars);

      // peida popup + puhasta vÃ¤ljad
      popup.style.display = "none";
      nameInput.value = "";
      amountInput.value = "";

      console.log("New jar added:", newJar);
    });
  });
</script>


</body>
</html>
