<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="./vars.css" />
  <link rel="stylesheet" href="./style.css" />

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      background: #f3f4f6;
    }
    .center-shell {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>

  <title>Goal Jar Tree View</title>
</head>
<body>
<div class="center-shell">

  <!-- ÃœHINE TELEFONIRAAM -->
  <div class="main-screen">
    <!-- STATUS BAR -->
    <div class="device-device-frame-components-status-bar">
      <div class="time">9:30</div>
      <img class="right-icons" src="right-icons0.svg" alt="status icons" />
      <img class="camera-cutout" src="camera-cutout0.svg" alt="" />
    </div>

    <!-- HOME indikator -->
    <div class="device-device-frame-components-navigation">
      <div class="home"></div>
    </div>

    <!-- SCROLLITAV SISU -->
    <div class="jar-content">

      <!-- Ãœlemine oranÅ¾ kaart (JS tÃ¤idab pÃ¤ris andmetega) -->
      <div class="jar-card">
        <div class="jar-emoji" id="jarEmoji">ðŸŽ¨</div>
        <div class="jar-text">
          <div class="jar-title" id="jarTitle">Art Supplies</div>
          <div class="jar-subtitle" id="jarSubtitle">Target: 50â‚¬</div>
        </div>
        <div class="jar-amount" id="jarAmount">0â‚¬</div>
      </div>

      <!-- Summa nupud -->
      <div class="chip-row">
        <button class="chip-button" data-add="5">+5â‚¬</button>
        <button class="chip-button" data-add="10">+10â‚¬</button>
        <button class="chip-button chip-outline" data-custom="true">Custom</button>
      </div>

      <!-- Puu / lehe pilt -->
      <div class="jar-image-wrap">
        <img class="jar-image" id="jarImage" src="leaf_0.png" alt="Savings tree" />
      </div>

      <!-- Alumine kollane nupp (nÃ¤itab palju on jÃ¤Ã¤nud) -->
      <button class="primary-button" id="jarPrimaryButton">
        15â‚¬ to go!
      </button>
    </div>

    <!-- ALUMINE NAV -->
    <div class="bottom-nav">
      <a href="../html/transactions.html" class="nav-item">
        <img src="history_image.svg" class="nav-icon" alt="History" />
        <div class="nav-label">History</div>
      </a>

      <a href="../html/main.html" class="nav-item">
        <img src="home_image.svg" class="nav-icon" alt="Home" />
        <div class="nav-label">Home</div>
      </a>

      <a href="../html/saving.html" class="nav-item">
        <img src="savings_image.svg" class="nav-icon" alt="Savings" />
        <div class="nav-label">Savings</div>
      </a>
    </div>

  </div><!-- /main-screen -->

</div><!-- /center-shell -->

<script>
  const STORAGE_KEY = "jarsData";

  // loe id URL-ist (?id=1)
  function getJarIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    return id ? parseInt(id, 10) : null;
  }

  async function getJarsData() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      return JSON.parse(stored);
    }
    // kui localStorage tÃ¼hi, loe algne JSON ja salvesta
    const response = await fetch("../data/jars.json");
    const data = await response.json();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    return data;
  }

  function saveJarsData(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function chooseImageSrc(percent) {
    if (percent <= 0) {
      return "../assets/images/12.png";    // 0%
    } else if (percent < 50) {
      return "../assets/images/10.png";    // 0â€“50%
    } else if (percent < 100) {
      return "../assets/images/9.png";    // 50â€“100%
    } else {
      return "../assets/images/8.png";    // 100% (Ãµitsev)
    }
  }

  function updateJarUI(jar) {
    const titleEl = document.getElementById("jarTitle");
    const subtitleEl = document.getElementById("jarSubtitle");
    const amountEl = document.getElementById("jarAmount");
    const primaryBtn = document.getElementById("jarPrimaryButton");
    const imageEl = document.getElementById("jarImage");
    const emojiEl = document.getElementById("jarEmoji");

    const goal = jar.goal || 0;
    const current = jar.current || 0;
    const percent = goal > 0 ? Math.min(100, (current / goal) * 100) : 0;
    const remaining = Math.max(0, goal - current);

    titleEl.textContent = jar.name || "Goal";
    subtitleEl.textContent = `Target: ${goal.toFixed(2)}â‚¬`;
    amountEl.textContent = `${current.toFixed(2)}â‚¬`;

    if (remaining <= 0) {
      primaryBtn.textContent = "Goal reached! ðŸŽ‰";
    } else {
      primaryBtn.textContent = `${remaining.toFixed(2)}â‚¬ to go!`;
    }

    // vali pilt protsendi jÃ¤rgi
    imageEl.src = chooseImageSrc(percent);

    // lihtne emoji loogika (soovi korral)
    if (percent >= 100) {
      emojiEl.textContent = "ðŸŒ¸";
    } else if (percent >= 50) {
      emojiEl.textContent = "ðŸŒ¿";
    } else if (percent > 0) {
      emojiEl.textContent = "ðŸŒ±";
    } else {
      emojiEl.textContent = "ðŸŒ°";
    }
  }

  async function initJarPage() {
    const data = await getJarsData();
    let jarId = getJarIdFromUrl();

    // kui url-is pole id-d, vÃµta esimene jar
    let jar = null;
    if (jarId != null) {
      jar = data.jars.find(j => j.id === jarId);
    }
    if (!jar) {
      jar = data.jars[0];
      jarId = jar.id;
    }

    updateJarUI(jar);

    // nupud
    const chipButtons = document.querySelectorAll(".chip-button");

    chipButtons.forEach(btn => {
      const addAmount = btn.dataset.add;
      const isCustom = btn.dataset.custom === "true";

      if (addAmount) {
        const value = parseFloat(addAmount);
        btn.addEventListener("click", () => {
          jar.current = (jar.current || 0) + value;
          // Ã¤ra lase Ã¼le eesmÃ¤rgi (soovi korral)
          if (jar.current > jar.goal) {
            jar.current = jar.goal;
          }
          saveJarsData(data);
          updateJarUI(jar);
        });
      } else if (isCustom) {
        btn.addEventListener("click", () => {
          const input = prompt("How much do you want to add? (â‚¬)");
          if (!input) return;
          const value = parseFloat(input.replace(",", "."));
          if (isNaN(value) || value <= 0) {
            alert("Please enter a valid positive number.");
            return;
          }
          jar.current = (jar.current || 0) + value;
          if (jar.current > jar.goal) {
            jar.current = jar.goal;
          }
          saveJarsData(data);
          updateJarUI(jar);
        });
      }
    });
  }

  document.addEventListener("DOMContentLoaded", initJarPage);
</script>

</body>
</html>
